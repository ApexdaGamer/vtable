<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VTable Dumper</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
    <style type="text/css">
      .steam-game-button-controls { opacity: 0; transition: opacity 0.2s; }
      .steam-game-button-controls:hover { opacity: 1; }
    </style>
  </head>
  <body>
    <div id="content" class="container"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.28.3/react-bootstrap.js"></script>
    <script type="text/babel">
      const { Row, Col, Image, ButtonToolbar, Button, ProgressBar } = ReactBootstrap;

      var stateManager = null;

      const Icon = (props) =>
        <i
          className={'fa fa-'+props.type+(props.spin ? ' fa-spin' : '')}
          style={{
            fontSize: (props.size || 'inherit'),
            verticalAlign: (props.middle ? 'middle' : 'inherit'),
          }}
        />;

      const FooterLink = (props) =>
        <a href={props.href} target="_blank" className="text-muted">{props.children}</a>

      const handleSteamGameButtonClick = (game, binary, event) => {
        stateManager.setState({ selectedBinary: (game+' '+binary.type), binaryDownloadProgress: { loaded: 0, total: 0 } });

        var xhr = new XMLHttpRequest();

        xhr.addEventListener('progress', (event) => {
          stateManager.setState({ binaryDownloadProgress: { loaded: event.loaded, total: event.total } });
        });

        xhr.addEventListener('load', (event) => {
          stateManager.setState({ binary: xhr.response });
        });

        xhr.open('GET', stateManager.state.gameList.base + binary.path);
        xhr.responseType = 'arraybuffer';

        xhr.send();
      }

      const SteamGameButton = (props) =>
        <Col xs={6} sm={4} className="text-center" style={{ position: 'relative' }}>
          <Image
            rounded responsive
            style={{ marginTop: 0, marginLeft: 'auto', marginBottom: 30, marginRight: 'auto' }}
            src={'https://steamcdn-a.akamaihd.net/steam/apps/' + props.game.appid + '/header.jpg'}
            alt={props.game.name}
          />
          <div className="steam-game-button-controls" style={{
            position: 'absolute', top: 0, left: 15, bottom: 30, right: 15,
            backgroundColor: 'rgba(255, 255, 255, 0.85)',
            border: '1px solid #ccc', borderRadius: 5,
            display: 'flex', alignItems: 'center', justifyContent: 'center',
          }}>
            <ButtonToolbar>
              {props.game.bins.map((binary) =>
                <Button
                  key={binary.type} bsSize="large"
                  onClick={handleSteamGameButtonClick.bind(null, props.game.name, binary)}
                >
                  <Icon type={
                    (binary.type === 'Engine') ? 'tachometer' :
                    (binary.type === 'Server') ? 'server' :
                    'question-circle'
                  } size="2em" /><br/>{binary.type}
                </Button>
              )}
            </ButtonToolbar>
          </div>
        </Col>

      const SteamGameList = (props) => <Row>
        {props.gameList.games.map((game) =>
          <SteamGameButton key={game.appid} game={game} />
        )}
      </Row>;

      const startHelpText =
        <span>Pick a <Icon type="steam" middle /> game or drop a <code>.so</code> file to start.</span>;

      const Layout = (props) => <div className="text-center">
        <div className="page-header">
          <h1>VTable Dumper</h1>
          <p className="lead">{props.title}</p>
        </div>
        <div className="page-header">
          {props.children}
        </div>
        <div className="text-muted text-lowercase" style={{ marginBottom: 20 }}>
          Made with <Icon type="heart" middle size="50%" /> by <FooterLink href="https://limetech.io">asherkin</FooterLink> <Icon type="circle" middle size="33%" /> Powered by <FooterLink href="http://emscripten.org">Emscripten</FooterLink> & <FooterLink href="http://www.mr511.de/software/english.html">libelf</FooterLink><br/>
          <small><FooterLink href="https://github.com/asherkin/vtable">I am Free Software, Fork me on GitHub</FooterLink></small>
        </div>
      </div>;

      const LoadingGameList = (props) =>
        <Layout title={startHelpText}>
          <div style={{ fontSize: 100, marginBottom: 30 }}>
            <Icon type="circle-o-notch" spin />
          </div>
        </Layout>;

      const PickAGame = (props) => {
        return <Layout title={startHelpText}>
          <SteamGameList gameList={props.gameList} />
        </Layout>;
      };

      const DownloadingBinary = (props) => {
        var helpText = <span>Downloading <Icon type="cloud-download" middle /> {props.binary} binary...</span>;
        return <Layout title={helpText}>
          <ProgressBar style={{ marginBottom: 30 }} now={props.loaded} max={props.total} striped active />
        </Layout>;
      };

      const ProcessingBinary = (props) => {
        var helpText = <span>Processing <Icon type="cogs" middle /> {props.binary} binary...</span>;
        return <Layout title={helpText}>
          <div style={{ fontSize: 100, marginBottom: 30 }}>
            <Icon type="circle-o-notch" spin />
          </div>
        </Layout>;
      };

      class StateManager extends React.Component {
        constructor(props) {
          super(props);
          this.state = {};
        }
        render() {
          if (this.state.binary)
            return <ProcessingBinary
              binary={this.state.selectedBinary}
            />;
          else if (this.state.selectedBinary)
            return <DownloadingBinary
              binary={this.state.selectedBinary}
              loaded={this.state.binaryDownloadProgress.loaded}
              total={this.state.binaryDownloadProgress.total}
            />;
          else if (this.state.gameList)
            return <PickAGame
              gameList={this.state.gameList}
            />;
          else
            return <LoadingGameList />;
        }
      }

      stateManager = window.state = ReactDOM.render(
        <StateManager />,
        document.getElementById('content')
      );

      const requestGamesList = () => {
        var xhr = new XMLHttpRequest();

        xhr.addEventListener('load', (event) => {
          stateManager.setState({ gameList: xhr.response });
        });

        xhr.open('GET', 'https://users.alliedmods.net/~asherkin/vtable/games.json');
        xhr.responseType = 'json';

        xhr.send();
      }

      requestGamesList();
    </script>
  </body>
</html>
