<!DOCTYPE html>
<html>
  <head>
    <title>VTable.js</title>
  </head>
  <body>
    <script type="application/javascript">
      var Module = {};
      var programInfo = null;

      var symbols = {};
      var vtables = {};

      function demangle(func) {
        try {
          var buf = Module['_malloc'](func.length);
          Module['writeStringToMemory'](func, buf);
          var status = Module['_malloc'](4);
          var ret = Module['___cxa_demangle'](buf, 0, 0, status);
          var intStatus = Module['getValue'](status, 'i32');
          switch (intStatus) {
            case 0:
              if (!ret) {
                throw '___cxa_demangle returned NULL';
              }
              return Module['Pointer_stringify'](ret);
            case -1:
              throw 'a memory allocation failiure occurred';
            case -2:
              throw 'input is not a valid name under the C++ ABI mangling rules';
            case -3:
              throw 'one of the arguments is invalid';
            default:
              throw 'encountered an unknown error';
          }
        } catch(e) {
          throw new Error('Failed to demangle ' + func + ' (' + e.message + ')');
        } finally {
          if (buf) Module['_free'](buf);
          if (status) Module['_free'](status);
          if (ret) Module['_free'](ret);
        }
      }

      function hex(n) {
         return ('0000000' + ((n|0)+4294967296).toString(16)).substr(-8);
      }

      function getRodata(programInfo, address, size) {
        for (var i = 0; i < programInfo.rodataChunks.size(); ++i) {
          var chunk = programInfo.rodataChunks.get(i);

          var start = address - (programInfo.rodataStart + chunk.offset);
          var end = start + size;

          if (start < 0 || end >= chunk.data.length) {
            continue;
          }

          return chunk.data.subarray(start, end);
        }

        throw new Error('Request out of bounds.');
      }

      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://users.alliedmods.net/~asherkin/public/bins/source/tf2/bin/engine_srv.so', true);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function() {
        programInfo = Module['process'](this.response);

        if (programInfo.error.length > 0) {
          console.error(programInfo.error);
          return;
        }

        console.log("symbols: " + programInfo.symbols.size());
        for (var i = 0; i < programInfo.symbols.size(); ++i) {
          var symbol = programInfo.symbols.get(i);

          if (symbol.name === '_ZTV17CHLTVDemoRecorder') {
            console.log(symbol);
          }

          if (symbol.address === 0) {
            continue;
          }

          symbols[symbol.address] = symbol.name;

          if (symbol.name.match(/^_ZTV/)) {
            vtables[symbol.name] = getRodata(programInfo, symbol.address, symbol.size);
          }
        }

        document.write('<pre>' + demangle("_ZTV17CHLTVDemoRecorder") + '\n');
        var vtable = vtables["_ZTV17CHLTVDemoRecorder"]
        var vtableView = new Uint32Array(vtable.buffer, vtable.byteOffset, vtable.byteLength / 4);
        for (var i = 2; i < vtableView.length; ++i) {
          var func = vtableView[i];
          var name = symbols[func];
          document.write(('   ' + (i - 2)).substr(-4) + ' ' + hex(func) + ' ' + demangle(name) + '\n');
        }
        document.write('</pre>');
      }
      xhr.send();
    </script>
    <script src="vtable.js"></script>
  </body>
</html>
