<!DOCTYPE html>
<html>
  <head>
    <title>VTable.js</title>
  </head>
  <body>
    <script type="application/javascript">
      var Module = {};
      var programInfo = null;

      var symbols = {};
      var vtables = {};
      var types = {};

      function cxa_demangle(func) {
        try {
          if (typeof func !== 'string') {
            throw new Error('input not a string');
          }
          var buf = Module['_malloc'](func.length + 1);
          Module['writeStringToMemory'](func, buf);
          var status = Module['_malloc'](4);
          var ret = Module['___cxa_demangle'](buf, 0, 0, status);
          var intStatus = Module['getValue'](status, 'i32');
          switch (intStatus) {
            case 0:
              if (!ret) {
                throw new Error('___cxa_demangle returned NULL');
              }
              return Module['Pointer_stringify'](ret);
            case -1:
              throw new Error('a memory allocation failiure occurred');
            case -2:
              throw new Error('input is not a valid name under the C++ ABI mangling rules');
            case -3:
              throw new Error('one of the arguments is invalid');
            default:
              throw new Error('encountered an unknown error');
          }
        } catch(e) {
          console.log('Failed to demangle \'' + func + '\' (' + e.message + ')');
          return func;
        } finally {
          if (buf) Module['_free'](buf);
          if (status) Module['_free'](status);
          if (ret) Module['_free'](ret);
        }
      }

      function hex(n) {
         return ('0000000' + ((n|0)+4294967296).toString(16)).substr(-8);
      }

      function getRodata(programInfo, address, size) {
        for (var i = 0; i < programInfo.rodataChunks.size(); ++i) {
          var chunk = programInfo.rodataChunks.get(i);

          var start = address - (programInfo.rodataStart + chunk.offset);
          var end = start + size;

          if (start < 0 || end >= chunk.data.length) {
            continue;
          }

          return chunk.data.subarray(start, end);
        }

        throw new Error('Request out of bounds.');
      }

      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://fennec.limetech.org/vtable-test/engine_srv.so', true);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function() {
        document.body.textContent = 'Processing...';
        programInfo = Module['process'](this.response);

        if (programInfo.error.length > 0) {
          document.body.textContent = 'Error: ' + programInfo.error;
          console.error(programInfo.error);
          return;
        }

        console.log("symbols: " + programInfo.symbols.size());
        for (var i = 0; i < programInfo.symbols.size(); ++i) {
          var symbol = programInfo.symbols.get(i);

          if (symbol.address === 0 || symbol.size === 0 || symbol.name.length === 0) {
            continue;
          }

          symbols[symbol.address] = symbol.name;

          if (symbol.name.match(/^_ZTV/)) {
            try {
              vtables[symbol.name] = getRodata(programInfo, symbol.address, symbol.size);
            } catch(e) {
              console.log('Got vtable symbol outside of .rodata: ' + symbol.name);
            }
          } else if (symbol.name.match(/^_ZTI/)) {
            try {
              types[symbol.name] = getRodata(programInfo, symbol.address, symbol.size);
            } catch(e) {
              console.log('Got typeinfo symbol outside of .rodata: ' + symbol.name);
            }
          }
        }

        window.setTimeout(function() {
          document.body.innerHTML = '';

          for (var typeSymbol in types) {
            var output = document.createElement('pre');
            output.textContent += cxa_demangle(typeSymbol) + '\n';
            var type = types[typeSymbol]
            var typeView = new Uint32Array(type.buffer, type.byteOffset, type.byteLength / 4);
            for (var i = 0; i < typeView.length; ++i) {
              var func = typeView[i];
              var name = symbols[func] || '';
              var index = i / (programInfo.addressSize / 4);
              output.textContent += (('   ' + index).substr(-4) + ' ' + hex(func) + ' ' + cxa_demangle(name) + '\n');
              if (programInfo.addressSize === 8) ++i;
            }
            document.body.appendChild(output);
          }

          for (var vtableSymbol in vtables) {
            var output = document.createElement('pre');
            output.textContent += cxa_demangle(vtableSymbol) + '\n';
            var vtable = vtables[vtableSymbol]
            var vtableView = new Uint32Array(vtable.buffer, vtable.byteOffset, vtable.byteLength / 4);
            for (var i = 0; i < vtableView.length; ++i) {
              var func = vtableView[i];
              var name = symbols[func] || '';
              var index = i / (programInfo.addressSize / 4);
              output.textContent += (('   ' + (index - 2)).substr(-4) + ' ' + hex(func) + ' ' + cxa_demangle(name) + '\n');
              if (programInfo.addressSize === 8) ++i;
            }
            document.body.appendChild(output);
          }
        }, 100);
      };
      window.onload = function() {
        document.body.textContent = 'Downloading...';
        xhr.send();
      };
    </script>
    <script src="vtable.js"></script>
  </body>
</html>
