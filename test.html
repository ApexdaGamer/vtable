<!DOCTYPE html>
<html>
  <head>
    <title>VTable.js</title>
  </head>
  <body>
    <script type="application/javascript">
      var Module = {};
      var programInfo = null;

      var symbols = {};
      var vtables = {};

      function hex(n) {
         return ('0000000' + ((n|0)+4294967296).toString(16)).substr(-8);
      }

      function getRodata(programInfo, address, size) {
        for (var i = 0; i < programInfo.rodataChunks.size(); ++i) {
          var chunk = programInfo.rodataChunks.get(i);

          var start = address - (programInfo.rodataStart + chunk.offset);
          var end = start + size;

          if (start < 0 || end >= chunk.data.length) {
            continue;
          }

          return chunk.data.subarray(start, end);
        }

        throw new Error('Request out of bounds.');
      }

      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://users.alliedmods.net/~asherkin/public/bins/source/tf2/bin/engine_srv.so', true);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function() {
        programInfo = Module.process(this.response);

        if (programInfo.error.length > 0) {
          console.error(programInfo.error);
          return;
        }

        console.log("symbols: " + programInfo.symbols.size());
        for (var i = 0; i < programInfo.symbols.size(); ++i) {
          var symbol = programInfo.symbols.get(i);

          if (symbol.name === '_ZTV17CHLTVDemoRecorder') {
            console.log(symbol);
          }

          if (symbol.address === 0) {
            continue;
          }

          symbols[symbol.address] = symbol.name;

          if (symbol.name.match(/^_ZTV/)) {
            vtables[symbol.name] = getRodata(programInfo, symbol.address, symbol.size);
          }
        }
      }
      xhr.send();
    </script>
    <script src="vtable.js"></script>
  </body>
</html>
